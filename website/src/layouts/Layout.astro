---
import pkg from '../../../package.json';

export interface Props {
  title?: string;
  description?: string;
  image?: string;
  canonical?: string;
}

const {
  title = "Eryxon Flow - Open Source Manufacturing Execution System",
  description = "Modern MES for sheet metal manufacturing. Real-time production tracking, QRM capacity management, time tracking, and complete API integration. Open source, self-hostable, production-ready.",
  image = "/og-image.jpg",
  canonical = "https://eryxon-flow.com"
} = Astro.props;

const fullTitle = title.includes("Eryxon Flow") ? title : `${title} | Eryxon Flow`;
---

<!doctype html>
<html lang="en" class="dark">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="generator" content={Astro.generator} />

    <!-- Primary Meta Tags -->
    <title>{fullTitle}</title>
    <meta name="title" content={fullTitle} />
    <meta name="description" content={description} />

    <!-- Canonical URL -->
    <link rel="canonical" href={canonical} />

    <!-- Open Graph / Facebook -->
    <meta property="og:type" content="website" />
    <meta property="og:url" content={canonical} />
    <meta property="og:title" content={fullTitle} />
    <meta property="og:description" content={description} />
    <meta property="og:image" content={image} />
    <meta property="og:site_name" content="Eryxon Flow" />

    <!-- Twitter -->
    <meta property="twitter:card" content="summary_large_image" />
    <meta property="twitter:url" content={canonical} />
    <meta property="twitter:title" content={fullTitle} />
    <meta property="twitter:description" content={description} />
    <meta property="twitter:image" content={image} />

    <!-- Additional SEO Meta Tags -->
    <meta name="keywords" content="manufacturing execution system, MES, sheet metal, production tracking, QRM, time tracking, open source, self-hosted, ERP integration, job tracking, operator terminal, real-time manufacturing" />
    <meta name="author" content="Sheet Metal Connect" />
    <meta name="robots" content="index, follow" />
    <meta name="language" content="English" />

    <!-- Favicon -->
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png" />
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png" />
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png" />
    <link rel="manifest" href="/site.webmanifest" />
    <meta name="theme-color" content="#1e90ff" />

    <!-- Preload critical resources -->
    <link rel="preload" href="/video-poster-small.webp" as="image" />

    <!-- Fonts - Inter (brand font) + JetBrains Mono -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet" />
    <link id="jetbrains-font" href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@100..800&display=swap" rel="stylesheet" media="print" />
    <noscript><link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@100..800&display=swap" rel="stylesheet" /></noscript>

    <!-- Defer font loading script -->
    <script is:inline>
      document.getElementById('jetbrains-font').media = 'all';
    </script>

    <!-- Terminal Styles -->
    <style>
      /* Terminal window styling */
      .terminal-window {
        @apply bg-card/50 backdrop-blur-xl rounded-xl border border-border/50;
      }

      .terminal-header {
        @apply flex items-center gap-2 px-4 py-3 bg-card/80 border-b border-border/50 rounded-t-xl;
      }

      .terminal-button {
        @apply w-3 h-3 rounded-full;
      }

      .terminal-button.red {
        @apply bg-red-500;
      }

      .terminal-button.yellow {
        @apply bg-yellow-500;
      }

      .terminal-button.green {
        @apply bg-green-500;
      }

      .terminal-title {
        @apply ml-2 text-sm font-medium text-muted-foreground;
      }

      /* Override small font sizes in terminals with proper monospace */
      .terminal-window .font-mono {
        font-family: 'JetBrains Mono', 'SF Mono', 'Consolas', 'Liberation Mono', 'Menlo', monospace !important;
        font-size: 1rem !important;
        line-height: 1.5 !important;
      }

      /* Specific overrides for terminal text */
      .terminal-window .text-sm {
        font-size: 1rem !important;
      }

      .terminal-window .text-xs {
        font-size: 0.9rem !important;
      }

      /* Ensure proper spacing in terminal content */
      .terminal-window pre,
      .terminal-window code {
        font-family: 'JetBrains Mono', 'SF Mono', 'Consolas', 'Liberation Mono', 'Menlo', monospace !important;
        font-size: 1rem !important;
        line-height: 1.5 !important;
      }

      /* Desktop terminal full width */
      .terminal-window {
        width: 100%;
        max-width: 100%;
      }

      /* Mobile terminal responsiveness */
      @media (max-width: 768px) {
        .terminal-window .font-mono,
        .terminal-window pre,
        .terminal-window code,
        .terminal-window .text-lg {
          font-size: 0.75rem !important;
          line-height: 1.3 !important;
        }

        .terminal-window .text-sm {
          font-size: 0.7rem !important;
        }

        /* Specific override for font-mono text-lg combination */
        .font-mono.text-lg.text-foreground {
          font-size: 1rem !important;
        }
      }

      @media (max-width: 640px) {
        .terminal-window {
          margin: 0 -0.5rem;
          border-radius: 0.75rem;
        }

        .terminal-window .font-mono,
        .terminal-window pre,
        .terminal-window code,
        .terminal-window .text-lg {
          font-size: 0.65rem !important;
          line-height: 1.2 !important;
        }

        .terminal-window .text-sm {
          font-size: 0.6rem !important;
        }

        .terminal-header {
          padding: 0.5rem 0.75rem;
        }

        .terminal-title {
          font-size: 0.7rem !important;
        }

        .terminal-window .p-6 {
          padding: 1rem !important;
        }

        /* Specific override for font-mono text-lg combination */
        .font-mono.text-lg.text-foreground {
          font-size: 1rem !important;
        }
      }

      @media (max-width: 480px) {
        .terminal-window .font-mono,
        .terminal-window pre,
        .terminal-window code,
        .terminal-window .text-lg {
          font-size: 0.6rem !important;
          line-height: 1.2 !important;
        }

        .terminal-window .text-sm {
          font-size: 0.55rem !important;
        }

        .terminal-title {
          font-size: 0.65rem !important;
        }

        .terminal-window .p-6 {
          padding: 0.75rem !important;
        }

        /* Specific override for font-mono text-lg combination */
        .font-mono.text-lg.text-foreground {
          font-size: 1rem !important;
        }
      }

    </style>

    <!-- JSON-LD Schema -->
    <script is:inline type="application/ld+json" set:html={JSON.stringify({
      "@context": "https://schema.org",
      "@type": "SoftwareApplication",
      "name": "Eryxon Flow",
      "description": "Open source Manufacturing Execution System (MES) for sheet metal manufacturing. Real-time production tracking, QRM capacity management, and complete API integration.",
      "url": "https://eryxon-flow.com",
      "downloadUrl": "https://github.com/SheetMetalConnect/eryxon-flow",
      "softwareVersion": pkg.version,
      "operatingSystem": ["macOS", "Windows", "Linux"],
      "applicationCategory": "BusinessApplication",
      "offers": {
        "@type": "Offer",
        "price": "0",
        "priceCurrency": "USD"
      },
      "author": {
        "@type": "Organization",
        "name": "Sheet Metal Connect",
        "url": "https://github.com/SheetMetalConnect"
      },
      "maintainer": {
        "@type": "Organization",
        "name": "Sheet Metal Connect",
        "url": "https://github.com/SheetMetalConnect"
      },
      "codeRepository": "https://github.com/SheetMetalConnect/eryxon-flow"
    })}></script>
  </head>
  <body class="min-h-screen text-foreground antialiased relative pt-24" style="background-color: #111927; background-image: radial-gradient(at 47% 33%, hsl(205.47, 77%, 40%) 0, transparent 59%), radial-gradient(at 82% 65%, hsl(218, 39%, 11%) 0, transparent 55%);">
    <!-- Animated Gradient Orbs (Design System) -->
    <div class="fixed inset-0 pointer-events-none z-0 overflow-hidden">
      <!-- Orb 1 - Blue -->
      <div class="absolute w-[500px] h-[500px] rounded-full opacity-50 animate-float" style="background: radial-gradient(circle, rgba(30, 144, 255, 0.4) 0%, transparent 70%); top: -10%; left: -10%; filter: blur(80px);"></div>
      <!-- Orb 2 - Yellow -->
      <div class="absolute w-[400px] h-[400px] rounded-full opacity-50 animate-float" style="background: radial-gradient(circle, rgba(251, 188, 5, 0.3) 0%, transparent 70%); bottom: -10%; right: -10%; filter: blur(80px); animation-delay: 7s;"></div>
      <!-- Orb 3 - Green -->
      <div class="absolute w-[350px] h-[350px] rounded-full opacity-50 animate-float" style="background: radial-gradient(circle, rgba(52, 168, 83, 0.3) 0%, transparent 70%); top: 50%; left: 50%; transform: translate(-50%, -50%); filter: blur(80px); animation-delay: 14s;"></div>
    </div>

    <!-- Main content wrapper -->
    <div class="relative z-10">
      <slot />
    </div>

    <!-- Global Scripts -->
    <script>
      // Theme toggle functionality
      const initTheme = () => {
        // Check localStorage first, then system preference, fallback to dark
        let theme = localStorage.getItem('theme');

        if (!theme) {
          // Check user's system preference
          theme = window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light';
          localStorage.setItem('theme', theme);
        }

        document.documentElement.classList.toggle('dark', theme === 'dark');
      };

      // Initialize theme immediately (before DOM load)
      initTheme();

      // Listen for system theme changes
      window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', (e) => {
        if (!localStorage.getItem('theme')) {
          const theme = e.matches ? 'dark' : 'light';
          localStorage.setItem('theme', theme);
          initTheme();
        }
      });

      // Listen for storage changes (theme toggle from ThemeToggle component)
      window.addEventListener('storage', (e) => {
        if (e.key === 'theme') {
          initTheme();
        }
      });

      // Custom event listener for theme changes within the same window
      window.addEventListener('themeChanged', initTheme);

      // Smooth scroll for anchor links - optimized to prevent forced reflows
      document.querySelectorAll('a[href^="#"]').forEach((anchor) => {
        const anchorEl = anchor as HTMLAnchorElement;
        anchorEl.addEventListener('click', function (e) {
          e.preventDefault();
          const href = anchorEl.getAttribute('href');
          if (href) {
            const target = document.querySelector(href);
            if (target) {
              // Use requestAnimationFrame to avoid forced reflow
              requestAnimationFrame(() => {
                target.scrollIntoView({
                  behavior: 'smooth',
                  block: 'start'
                });
              });
            }
          }
        });
      });

      // Animation on scroll - optimized to prevent forced reflows
      const observeElements = () => {
        const observer = new IntersectionObserver((entries) => {
          // Batch DOM operations to prevent forced reflows
          const elementsToAnimate: Element[] = [];
          entries.forEach(entry => {
            if (entry.isIntersecting) {
              elementsToAnimate.push(entry.target);
            }
          });

          // Apply all animations in a single requestAnimationFrame
          if (elementsToAnimate.length > 0) {
            requestAnimationFrame(() => {
              elementsToAnimate.forEach(element => {
                element.classList.add('animate-fade-in-up');
              });
            });
          }
        }, {
          threshold: 0.1,
          rootMargin: '0px 0px -50px 0px'
        });

        document.querySelectorAll('.fade-in-on-scroll').forEach(el => {
          observer.observe(el);
        });
      };

      // Initialize animations after DOM load
      document.addEventListener('DOMContentLoaded', observeElements);
    </script>

  </body>
</html>
