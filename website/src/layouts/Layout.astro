---
import pkg from '../../../package.json';

export interface Props {
  title?: string;
  description?: string;
  image?: string;
  canonical?: string;
}

const {
  title = "Eryxon Flow - Open Source Manufacturing Execution System",
  description = "Modern MES for sheet metal manufacturing. Real-time production tracking, QRM capacity management, time tracking, and complete API integration. Open source, self-hostable, production-ready.",
  image = "/og-image.jpg",
  canonical = "https://eryxon-flow.com"
} = Astro.props;

const fullTitle = title.includes("Eryxon Flow") ? title : `${title} | Eryxon Flow`;
---

<!doctype html>
<html lang="en" class="dark">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="generator" content={Astro.generator} />

    <!-- Primary Meta Tags -->
    <title>{fullTitle}</title>
    <meta name="title" content={fullTitle} />
    <meta name="description" content={description} />

    <!-- Canonical URL -->
    <link rel="canonical" href={canonical} />

    <!-- Open Graph / Facebook -->
    <meta property="og:type" content="website" />
    <meta property="og:url" content={canonical} />
    <meta property="og:title" content={fullTitle} />
    <meta property="og:description" content={description} />
    <meta property="og:image" content={image} />
    <meta property="og:site_name" content="Eryxon Flow" />

    <!-- Twitter -->
    <meta property="twitter:card" content="summary_large_image" />
    <meta property="twitter:url" content={canonical} />
    <meta property="twitter:title" content={fullTitle} />
    <meta property="twitter:description" content={description} />
    <meta property="twitter:image" content={image} />

    <!-- Additional SEO Meta Tags -->
    <meta name="keywords" content="manufacturing execution system, MES, sheet metal, production tracking, QRM, time tracking, open source, self-hosted, ERP integration, job tracking, operator terminal, real-time manufacturing" />
    <meta name="author" content="Sheet Metal Connect" />
    <meta name="robots" content="index, follow" />
    <meta name="language" content="English" />

    <!-- Favicon -->
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png" />
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png" />
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png" />
    <link rel="manifest" href="/site.webmanifest" />
    <meta name="theme-color" content="#1e90ff" />

    <!-- Preload critical resources -->
    <link rel="preload" href="/video-poster-small.webp" as="image" />

    <!-- Fonts - Inter (brand font) + JetBrains Mono -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet" />
    <link id="jetbrains-font" href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@100..800&display=swap" rel="stylesheet" media="print" />
    <noscript><link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@100..800&display=swap" rel="stylesheet" /></noscript>

    <!-- Defer font loading script -->
    <script is:inline>
      document.getElementById('jetbrains-font').media = 'all';
    </script>

    <!-- Terminal Styles -->
    <style>
      /* Terminal window styling */
      .terminal-window {
        @apply bg-card/50 backdrop-blur-xl rounded-xl border border-border/50;
      }

      .terminal-header {
        @apply flex items-center gap-2 px-4 py-3 bg-card/80 border-b border-border/50 rounded-t-xl;
      }

      .terminal-button {
        @apply w-3 h-3 rounded-full;
      }

      .terminal-button.red {
        @apply bg-red-500;
      }

      .terminal-button.yellow {
        @apply bg-yellow-500;
      }

      .terminal-button.green {
        @apply bg-green-500;
      }

      .terminal-title {
        @apply ml-2 text-sm font-medium text-muted-foreground;
      }

      /* Override small font sizes in terminals with proper monospace */
      .terminal-window .font-mono {
        font-family: 'JetBrains Mono', 'SF Mono', 'Consolas', 'Liberation Mono', 'Menlo', monospace !important;
        font-size: 1rem !important;
        line-height: 1.5 !important;
      }

      /* Specific overrides for terminal text */
      .terminal-window .text-sm {
        font-size: 1rem !important;
      }

      .terminal-window .text-xs {
        font-size: 0.9rem !important;
      }

      /* Ensure proper spacing in terminal content */
      .terminal-window pre,
      .terminal-window code {
        font-family: 'JetBrains Mono', 'SF Mono', 'Consolas', 'Liberation Mono', 'Menlo', monospace !important;
        font-size: 1rem !important;
        line-height: 1.5 !important;
      }

      /* Desktop terminal full width */
      .terminal-window {
        width: 100%;
        max-width: 100%;
      }

      /* Mobile terminal responsiveness */
      @media (max-width: 768px) {
        .terminal-window .font-mono,
        .terminal-window pre,
        .terminal-window code,
        .terminal-window .text-lg {
          font-size: 0.75rem !important;
          line-height: 1.3 !important;
        }

        .terminal-window .text-sm {
          font-size: 0.7rem !important;
        }

        /* Specific override for font-mono text-lg combination */
        .font-mono.text-lg.text-foreground {
          font-size: 1rem !important;
        }
      }

      @media (max-width: 640px) {
        .terminal-window {
          margin: 0 -0.5rem;
          border-radius: 0.75rem;
        }

        .terminal-window .font-mono,
        .terminal-window pre,
        .terminal-window code,
        .terminal-window .text-lg {
          font-size: 0.65rem !important;
          line-height: 1.2 !important;
        }

        .terminal-window .text-sm {
          font-size: 0.6rem !important;
        }

        .terminal-header {
          padding: 0.5rem 0.75rem;
        }

        .terminal-title {
          font-size: 0.7rem !important;
        }

        .terminal-window .p-6 {
          padding: 1rem !important;
        }

        /* Specific override for font-mono text-lg combination */
        .font-mono.text-lg.text-foreground {
          font-size: 1rem !important;
        }
      }

      @media (max-width: 480px) {
        .terminal-window .font-mono,
        .terminal-window pre,
        .terminal-window code,
        .terminal-window .text-lg {
          font-size: 0.6rem !important;
          line-height: 1.2 !important;
        }

        .terminal-window .text-sm {
          font-size: 0.55rem !important;
        }

        .terminal-title {
          font-size: 0.65rem !important;
        }

        .terminal-window .p-6 {
          padding: 0.75rem !important;
        }

        /* Specific override for font-mono text-lg combination */
        .font-mono.text-lg.text-foreground {
          font-size: 1rem !important;
        }
      }

    </style>

    <!-- JSON-LD Schema -->
    <script is:inline type="application/ld+json" set:html={JSON.stringify({
      "@context": "https://schema.org",
      "@type": "SoftwareApplication",
      "name": "Eryxon Flow",
      "description": "Open source Manufacturing Execution System (MES) for sheet metal manufacturing. Real-time production tracking, QRM capacity management, and complete API integration.",
      "url": "https://eryxon-flow.com",
      "downloadUrl": "https://github.com/SheetMetalConnect/eryxon-flow",
      "softwareVersion": pkg.version,
      "operatingSystem": ["macOS", "Windows", "Linux"],
      "applicationCategory": "BusinessApplication",
      "offers": {
        "@type": "Offer",
        "price": "0",
        "priceCurrency": "USD"
      },
      "author": {
        "@type": "Organization",
        "name": "Sheet Metal Connect",
        "url": "https://github.com/SheetMetalConnect"
      },
      "maintainer": {
        "@type": "Organization",
        "name": "Sheet Metal Connect",
        "url": "https://github.com/SheetMetalConnect"
      },
      "codeRepository": "https://github.com/SheetMetalConnect/eryxon-flow"
    })}></script>
    <!-- Global font scaling for professional look -->
    <style is:global>
      /* Reduce base font sizes for cleaner, more professional appearance */
      :root {
        --font-scale: 0.9;
      }

      /* Scale down heading sizes */
      h1, .hero-title {
        font-size: clamp(2rem, 5vw, 3.5rem) !important;
        line-height: 1.15;
        letter-spacing: -0.02em;
      }

      h2, .section-title {
        font-size: clamp(1.75rem, 4vw, 2.5rem) !important;
        line-height: 1.2;
        letter-spacing: -0.01em;
      }

      h3 {
        font-size: clamp(1.125rem, 2.5vw, 1.5rem) !important;
        line-height: 1.3;
      }

      h4 {
        font-size: clamp(1rem, 2vw, 1.125rem) !important;
        line-height: 1.4;
      }

      /* Body text sizing */
      body {
        font-size: 0.9375rem;
        line-height: 1.6;
      }

      /* Scale paragraph text */
      p {
        font-size: 0.9375rem;
        line-height: 1.65;
      }

      /* Larger lead text */
      .text-xl {
        font-size: 1.0625rem !important;
      }

      .text-2xl {
        font-size: 1.25rem !important;
      }

      .text-3xl {
        font-size: 1.5rem !important;
      }

      /* Scale down hero-specific sizes */
      .text-4xl {
        font-size: 1.75rem !important;
      }

      .text-5xl {
        font-size: 2rem !important;
      }

      .text-6xl {
        font-size: 2.5rem !important;
      }

      .text-7xl {
        font-size: 3rem !important;
      }

      .text-8xl {
        font-size: 3.5rem !important;
      }

      /* Keep small text readable */
      .text-sm {
        font-size: 0.8125rem !important;
      }

      .text-xs {
        font-size: 0.75rem !important;
      }

      /* Improve font rendering */
      * {
        -webkit-font-smoothing: antialiased;
        -moz-osx-font-smoothing: grayscale;
      }

      /* Tighten letter spacing for headers */
      h1, h2, h3, h4 {
        font-feature-settings: 'kern' 1, 'liga' 1;
      }

      /* Professional button styling */
      .btn-primary {
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.75rem 1.5rem;
        border-radius: 0.5rem;
        font-weight: 500;
        font-size: 0.875rem;
        transition: all 0.2s ease;
        background: #3b82f6;
        color: white;
        border: none;
      }

      .btn-primary:hover {
        background: #2563eb;
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(59, 130, 246, 0.25);
      }

      .btn-secondary {
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.75rem 1.5rem;
        border-radius: 0.5rem;
        font-weight: 500;
        font-size: 0.875rem;
        transition: all 0.2s ease;
        background: transparent;
        color: #fafafa;
        border: 1px solid rgba(255, 255, 255, 0.1);
      }

      .btn-secondary:hover {
        background: rgba(255, 255, 255, 0.05);
        border-color: rgba(255, 255, 255, 0.2);
      }

      /* Calmer gradient text */
      .gradient-text {
        background: linear-gradient(135deg, #ffffff 0%, #a1a1aa 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
      }

      /* Reduce animation intensity for professionalism */
      @media (prefers-reduced-motion: no-preference) {
        .animate-float {
          animation-duration: 30s !important; /* Slower, calmer */
        }
      }

      /* More subtle card styling */
      .card {
        background: rgba(24, 24, 27, 0.5);
        border: 1px solid rgba(255, 255, 255, 0.05);
        border-radius: 0.75rem;
        padding: 1.5rem;
        transition: all 0.2s ease;
      }

      .card:hover {
        border-color: rgba(255, 255, 255, 0.1);
        background: rgba(24, 24, 27, 0.7);
      }

      /* Professional spacing */
      section {
        padding-top: 4rem;
        padding-bottom: 4rem;
      }

      @media (min-width: 768px) {
        section {
          padding-top: 5rem;
          padding-bottom: 5rem;
        }
      }

      /* Clean link styling */
      a {
        transition: color 0.15s ease;
      }

      /* Subtle focus states */
      a:focus-visible,
      button:focus-visible {
        outline: 2px solid rgba(59, 130, 246, 0.5);
        outline-offset: 2px;
      }

      /* Improve table styling for consistency */
      table {
        border-collapse: separate;
        border-spacing: 0;
      }

      th, td {
        padding: 0.875rem 1rem;
      }

      /* Consistent badge styling */
      .badge {
        display: inline-flex;
        align-items: center;
        gap: 0.375rem;
        padding: 0.25rem 0.625rem;
        border-radius: 9999px;
        font-size: 0.75rem;
        font-weight: 500;
        letter-spacing: 0.01em;
      }
    </style>
  </head>
  <body class="min-h-screen text-foreground antialiased relative pt-24 bg-background selection:bg-accent selection:text-white overflow-x-hidden">
    <!-- Background Gradients -->
    <div class="fixed inset-0 pointer-events-none z-0">
        <div class="absolute inset-0 bg-[radial-gradient(ellipse_at_top,_var(--tw-gradient-stops))] from-zinc-900/20 via-background to-background"></div>
        <div class="absolute top-0 left-0 right-0 h-[500px] bg-gradient-to-b from-accent/5 to-transparent opacity-30 blur-[100px]"></div>
    </div>

    <!-- Subtle Background Accent (professional, minimal) -->
    <div class="fixed inset-0 pointer-events-none z-0 overflow-hidden">
      <!-- Single subtle blue glow at top -->
      <div class="absolute w-[800px] h-[400px] rounded-full opacity-[0.08]" style="background: radial-gradient(ellipse, rgba(59, 130, 246, 0.4) 0%, transparent 70%); top: -15%; left: 50%; transform: translateX(-50%); filter: blur(80px);"></div>
    </div>

    <!-- Main content wrapper -->
    <div class="relative z-10">
      <slot />
    </div>

    <!-- Global Scripts -->
    <script>
      // Theme toggle functionality
      const initTheme = () => {
        // Check localStorage first, then system preference, fallback to dark
        let theme = localStorage.getItem('theme');

        if (!theme) {
          // Check user's system preference
          theme = window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light';
          localStorage.setItem('theme', theme);
        }

        document.documentElement.classList.toggle('dark', theme === 'dark');
      };

      // Initialize theme immediately (before DOM load)
      initTheme();

      // Listen for system theme changes
      window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', (e) => {
        if (!localStorage.getItem('theme')) {
          const theme = e.matches ? 'dark' : 'light';
          localStorage.setItem('theme', theme);
          initTheme();
        }
      });

      // Listen for storage changes (theme toggle from ThemeToggle component)
      window.addEventListener('storage', (e) => {
        if (e.key === 'theme') {
          initTheme();
        }
      });

      // Custom event listener for theme changes within the same window
      window.addEventListener('themeChanged', initTheme);

      // Smooth scroll for anchor links - optimized to prevent forced reflows
      document.querySelectorAll('a[href^="#"]').forEach((anchor) => {
        const anchorEl = anchor as HTMLAnchorElement;
        anchorEl.addEventListener('click', function (e) {
          e.preventDefault();
          const href = anchorEl.getAttribute('href');
          if (href) {
            const target = document.querySelector(href);
            if (target) {
              // Use requestAnimationFrame to avoid forced reflow
              requestAnimationFrame(() => {
                target.scrollIntoView({
                  behavior: 'smooth',
                  block: 'start'
                });
              });
            }
          }
        });
      });

      // Animation on scroll - optimized to prevent forced reflows
      const observeElements = () => {
        const observer = new IntersectionObserver((entries) => {
          // Batch DOM operations to prevent forced reflows
          const elementsToAnimate: Element[] = [];
          entries.forEach(entry => {
            if (entry.isIntersecting) {
              elementsToAnimate.push(entry.target);
            }
          });

          // Apply all animations in a single requestAnimationFrame
          if (elementsToAnimate.length > 0) {
            requestAnimationFrame(() => {
              elementsToAnimate.forEach(element => {
                element.classList.add('animate-fade-in-up');
              });
            });
          }
        }, {
          threshold: 0.1,
          rootMargin: '0px 0px -50px 0px'
        });

        document.querySelectorAll('.fade-in-on-scroll').forEach(el => {
          observer.observe(el);
        });
      };

      // Initialize animations after DOM load
      document.addEventListener('DOMContentLoaded', observeElements);
    </script>

    <!-- i18n Initialization -->
    <script>
      import { initI18n, applyTranslations, getCurrentLocale, translations } from '@i18n/client';

      // Apply translations on page load
      document.addEventListener('DOMContentLoaded', () => {
        const locale = getCurrentLocale();
        const t = translations[locale];

        // Apply translations to data-i18n elements
        applyTranslations(locale);

        // Update specific sections that need more complex translations
        updateHeroSection(t);
        updateFeaturesSection(t);
        updateComparisonSection(t);
        updateHowItWorksSection(t);
        updateGetStartedSection(t);
        updateFooterSection(t);
      });

      function updateHeroSection(t: any) {
        // Hero badges
        const badges = document.querySelectorAll('.floating-badges span');
        if (badges.length >= 3) {
          badges[0].innerHTML = `<span class="w-1.5 h-1.5 bg-emerald-500 rounded-full"></span>${t.hero.badge.openSource}`;
          badges[1].textContent = t.hero.badge.license;
          badges[2].textContent = t.hero.badge.selfHostable;
        }

        // Hero title and text
        const heroTitle = document.querySelector('.gradient-text');
        if (heroTitle) heroTitle.textContent = t.hero.title;

        const tagline = document.querySelector('section p.text-xl.sm\\:text-2xl');
        if (tagline) tagline.textContent = t.hero.tagline;

        // Hero description
        const heroDesc = document.querySelector('section p.text-lg.sm\\:text-xl.text-muted-foreground');
        if (heroDesc) heroDesc.textContent = t.hero.description;

        // CTA buttons
        const ctaButtons = document.querySelectorAll('section .flex.flex-col.sm\\:flex-row a');
        if (ctaButtons.length >= 2) {
          const getStartedBtn = ctaButtons[0];
          const githubBtn = ctaButtons[1];
          // Keep SVG, update text
          const getStartedSvg = getStartedBtn.querySelector('svg');
          if (getStartedSvg) {
            getStartedBtn.innerHTML = '';
            getStartedBtn.appendChild(getStartedSvg);
            getStartedBtn.appendChild(document.createTextNode(t.hero.cta.getStarted));
          }
          const githubSvg = githubBtn.querySelector('svg');
          if (githubSvg) {
            githubBtn.innerHTML = '';
            githubBtn.appendChild(githubSvg);
            githubBtn.appendChild(document.createTextNode(t.hero.cta.viewGithub));
          }
        }

        // Stats labels
        const statLabels = document.querySelectorAll('.grid.grid-cols-2.md\\:grid-cols-4 .text-sm.text-zinc-500');
        if (statLabels.length >= 4) {
          statLabels[0].textContent = t.hero.stats.uiComponents;
          statLabels[1].textContent = t.hero.stats.edgeFunctions;
          statLabels[2].textContent = t.hero.stats.languages;
          statLabels[3].textContent = t.hero.stats.apiReady;
        }
      }

      function updateFeaturesSection(t: any) {
        // Features section title
        const featuresSection = document.getElementById('features');
        if (!featuresSection) return;

        const sectionTitle = featuresSection.querySelector('h2.gradient-text');
        if (sectionTitle) sectionTitle.textContent = t.features.title;

        const sectionDesc = featuresSection.querySelector('p.text-xl.text-muted-foreground');
        if (sectionDesc) sectionDesc.textContent = t.features.description;

        // CTA at bottom
        const ctaText = featuresSection.querySelector('.inline-flex.items-center span');
        if (ctaText) ctaText.textContent = t.features.callToAction;
      }

      function updateComparisonSection(t: any) {
        const compareSection = document.getElementById('compare');
        if (!compareSection) return;

        // Badge
        const badge = compareSection.querySelector('span.inline-block.px-4');
        if (badge) badge.textContent = t.comparison.badge;

        // Title
        const title = compareSection.querySelector('h2.gradient-text');
        if (title) title.textContent = t.comparison.title;

        // Subtitle
        const subtitle = compareSection.querySelector('p.text-xl.text-zinc-400');
        if (subtitle) subtitle.textContent = t.comparison.subtitle;

        // Team section
        const teamTitle = compareSection.querySelector('.mt-16 h3');
        if (teamTitle) teamTitle.textContent = t.comparison.teamSection.title;

        const teamDesc = compareSection.querySelector('.mt-16 p.text-zinc-400');
        if (teamDesc) teamDesc.textContent = t.comparison.teamSection.description;
      }

      function updateHowItWorksSection(t: any) {
        const howSection = document.getElementById('how-it-works');
        if (!howSection) return;

        // Title
        const title = howSection.querySelector('h2.gradient-text');
        if (title) title.textContent = t.howItWorks.title;

        // Description
        const desc = howSection.querySelector('p.text-xl.text-zinc-400');
        if (desc) desc.textContent = t.howItWorks.description;

        // Architecture title
        const archTitle = howSection.querySelector('.mt-16 h3.text-2xl');
        if (archTitle) archTitle.textContent = t.howItWorks.architecture.title;

        // CTA section
        const ctaTitle = howSection.querySelector('.text-center.mt-16 h3');
        if (ctaTitle) ctaTitle.textContent = t.howItWorks.callToAction.title;

        const ctaDesc = howSection.querySelector('.text-center.mt-16 p.text-zinc-400');
        if (ctaDesc) ctaDesc.textContent = t.howItWorks.callToAction.description;
      }

      function updateGetStartedSection(t: any) {
        const gsSection = document.getElementById('get-started');
        if (!gsSection) return;

        // Title
        const title = gsSection.querySelector('h2.gradient-text');
        if (title) title.textContent = t.getStarted.title;

        // Description
        const desc = gsSection.querySelector('p.text-xl.text-muted-foreground');
        if (desc) desc.textContent = t.getStarted.description;

        // Terminal title
        const termTitle = gsSection.querySelector('.terminal-title');
        if (termTitle) termTitle.textContent = t.getStarted.terminal.title;
      }

      function updateFooterSection(t: any) {
        const footer = document.querySelector('footer');
        if (!footer) return;

        // Footer description
        const desc = footer.querySelector('.md\\:col-span-2 p.text-muted-foreground');
        if (desc) desc.textContent = t.footer.description;

        // Quick Links title
        const quickLinksTitle = footer.querySelectorAll('h3')[0];
        if (quickLinksTitle) quickLinksTitle.textContent = t.footer.quickLinks.title;

        // Community title
        const communityTitle = footer.querySelectorAll('h3')[1];
        if (communityTitle) communityTitle.textContent = t.footer.community.title;

        // Bottom bar
        const copyright = footer.querySelector('.border-t p.text-muted-foreground');
        if (copyright) {
          copyright.innerHTML = `2025 <a href="https://www.sheetmetalconnect.com/" target="_blank" rel="noopener noreferrer" class="hover:text-foreground transition-colors">Sheet Metal Connect e.U.</a> ${t.footer.bottomBar.copyright.split('Released')[1] ? 'Released' + t.footer.bottomBar.copyright.split('Released')[1] : ''}`;
        }

        const madeBy = footer.querySelector('.border-t span');
        if (madeBy) {
          madeBy.innerHTML = `${t.footer.bottomBar.madeBy.split('Luke')[0]}<a href="https://vanenkhuizen.com" target="_blank" rel="noopener noreferrer" class="hover:text-foreground transition-colors">Luke van Enkhuizen</a>${t.footer.bottomBar.madeBy.split('Luke van Enkhuizen')[1] || ''}`;
        }
      }
    </script>

  </body>
</html>
